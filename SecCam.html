<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
        <meta name="description" content="Security Camera for mobile devices by Net IT Australia"/> 
        <meta name="keywords" content="Security Camera, Net IT Australia, netit.com.au"/> 
        <meta name="author" content="Net IT Australia"/>
        <title>Security Camera</title>

        <!-- <script type="mdoule" src="../../!js/NetITAustralia.js"></script> -->

        <style>

            .media-container {
                position:relative;
                top:3px;
                left:3px;
                height:240px;
            }

            .media-element{
                position:absolute;
                top:0px;
                left:0px;
                width: 320px;
                height: 240px;
                border: 2px solid black; /* Optional for visibility */
                object-fit: cover; /* Ensures proper scaling for images and videos */
            }

            .webcam-video{
                z-index: 1;
            }
            .video-canvas{
                z-index: 2;
                /* display:none; */
            }
            .canvas-image{
                z-index: 3;
                opacity:50%;
            }

            .sec-cam-dashboard{
                border:2px solid black;
                margin-top:10px;
                margin-left:3px;
                width: 320px;
            }
            .sec-cam-dashboard p{
                background: rgba(0, 0, 0, 0.2); /* Semi-transparent background */
                padding: 10px;
                border-radius: 5px;
                text-align: center;
            }

            .previewImageContainer{
                position:relative;
                left:3px;
                height:240px;
                margin-top: 3px;
            }
            .previewImage{
                position:absolute;
                top:0px;
                left:0px;
                width: 320px;
                height: 240px;
                border: 2px solid black; /* Optional for visibility */
                object-fit: cover; /* Ensures proper scaling for images and videos */
            }
            .previewImageContainer div{
                text-align: center;
                position: relative;
                width:320px;
                top:1px;
                left:1px;
                background-color: white;
                color:blue;
                border:1px solid blue;
                z-index: 300;
            }

            .wrapperStartStopButtons{
                position:absolute;
                width:310px;                
                top:5px;
                left:5px;
                display:flex;
                flex-direction: row;
                justify-content:space-between;
                z-index: 200;
            }
            .stopButton{
                margin:5px;
                padding:5px;
                color:white;
                background-color: red;
                cursor:pointer;
            }
            .startButton{
                margin:5px;
                padding:5px;
                color:white;
                background-color: green;
                cursor:pointer;
            }

            .wrapperCameraFacingModeToggle{
                position:absolute;
                width:310px;                
                bottom:5px;
                left:5px;
                display:flex;
                flex-direction: row;
                justify-content:space-around;
                z-index: 200;
            }
            .cameraFacingModeToggle{
                visibility:hidden;
                margin:5px;
                padding:5px;
                color:black;
                background-color: white;
                cursor:pointer;
                border:1px solid black
            }

            #custom-alert-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
            }
            #custom-alert-dialog {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ffffff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                text-align: center;
            }
            #custom-alert-dialog button {
                margin-top: 10px;
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                background-color: #007bff;
                color: white;
                cursor: pointer;
            }
            #custom-alert-dialog button:hover {
                background-color: #0056b3;
            }

            #stillFrameHistoryContainer{
                margin-top:10px;
                margin-left:3px;
                width: 320px;
                border: 1px solid darkgreen;
            }
            #stillFrameHistory{
                padding-left: 3px;
                color:yellow;
                background-color:darkcyan;
                font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            }

        </style>

        <script>

            const consoleLog = true;

            // _dateTime() START
                function _DateTime(){
                    const weekDaysShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
                    const weekDaysLong = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']
                    const monthsShort = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    const monthsLong = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                    const newDate = new Date();

                    // console.log('newDate',newDate);
                    // console.log('newDate.toDateString()',newDate.toDateString());
                    // console.log('newDate.toISOString()',newDate.toISOString());
                    // console.log('newDate.toJSON()',newDate.toJSON());
                    // console.log('newDate.toLocaleDateString()',newDate.toLocaleDateString());
                    // console.log('newDate.toLocaleString()',newDate.toLocaleString());
                    // console.log('newDate.toLocaleTimeString()',newDate.toLocaleTimeString());
                    // console.log('newDate.toString()',newDate.toString());
                    // console.log('newDate.toTimeString()',newDate.toTimeString());
                    // console.log('newDate.toUTCString()',newDate.toUTCString());
                    // console.log('newDate.getTimezoneOffset()',newDate.getTimezoneOffset());
                    // console.log('newDate.getTime()',newDate.getTime());
                    // console.log('newDate.getDate()',newDate.getDate());
                    // console.log('newDate.getDay()',newDate.getDay());
                    // console.log('newDate.getMonth()',newDate.getMonth());
                    // console.log('newDate.getFullYear()',newDate.getFullYear());
                    // console.log('newDate.getHours()',newDate.getHours());
                    // console.log('newDate.getMinutes()',newDate.getMinutes());
                    // console.log('newDate.getSeconds()',newDate.getSeconds());
                    // console.log('newDate.getMilliseconds()',newDate.getMilliseconds());
                    // console.log('newDate.getUTCDate()',newDate.getUTCDate());
                    // console.log('newDate.getUTCDay()',newDate.getUTCDay());
                    // console.log('newDate.getUTCMonth()',newDate.getUTCMonth());
                    // console.log('newDate.getUTCFullYear()',newDate.getUTCFullYear());
                    // console.log('newDate.getUTCHours()',newDate.getUTCHours());
                    // console.log('newDate.getUTCMinutes()',newDate.getUTCMinutes());
                    // console.log('newDate.getUTCSeconds()',newDate.getUTCSeconds());
                    // console.log('newDate.getUTCMilliseconds()',newDate.getUTCMilliseconds());

                    const date = newDate.getDate().toString().padStart(2, '0');
                    const day = newDate.getDay().toString();
                    const month = (newDate.getMonth() + 1).toString().padStart(2, '0');
                    const year = newDate.getFullYear().toString();
                    const hour = newDate.getHours();
                    const minute = newDate.getMinutes().toString().padStart(2, '0');
                    const second = newDate.getSeconds().toString().padStart(2, '0');
                    const millisecond = newDate.getMilliseconds().toString();
                    const weekDayShort = weekDaysShort[newDate.getDay()];
                    const weekDayLong = weekDaysLong[newDate.getDay()];
                    const monthShort = monthsShort[newDate.getMonth()];
                    const monthLong = monthsLong[newDate.getMonth()];

                    let hour24 = hour.toString().padStart(2,"0");
                    let hour12 = hour.toString().padStart(2,"0");
                    let ampm = "am"
                    if(hour > 12){
                        hour12 = (hour - 12).toString().padStart(2,"0");
                        ampm = "pm"
                    }

                    const jsonObject = {
                        newDate: newDate,
                        date:date,
                        day:day,
                        month:month,
                        year:year,
                        hour24:hour24,
                        hour12:hour12,
                        minute:minute,
                        second:second,
                        millisecond:millisecond,
                        weekDayShort:weekDayShort,
                        weekDayLong:weekDayLong,
                        monthShort:monthShort,
                        monthLong:monthLong,
                        yyyymmdd:`${year}-${month}-${date}`,
                        hhmmss24:`${hour24}:${minute}:${second}`,
                        hhmmss12:`${hour12}:${minute}:${second}`,
                        ampm:ampm
                    };
                    return jsonObject;
                    // _dateTime() END
                }
                let moment = _DateTime();
                console.log(`Security Camera started at: `,moment.yyyymmdd, moment.hhmmss24, moment.ampm);

            // detectDeviceType() START
                function detectDeviceType() {
                    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                    // Check for iPads and iPhones
                        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                            return "iOS Device (iPhone or iPad)";
                        }
                    // Check for Android devices
                        if (/android/i.test(userAgent)) {
                            return "Android Device";
                        }
                    // Check for other tablets (basic heuristic)
                        if (screen.width > 768 && screen.width <= 1024) {
                            return "Tablet";
                        }
                    // Assume desktop for larger screens
                        if (screen.width > 1024) {
                            return "Desktop or Laptop";
                        }
                    // Default fallback
                        return "Unknown Device";
                    // detectDeviceType() END
                }
                console.log(detectDeviceType());

            // detectOS() START
                function detectOS() {
                    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                    if (/Windows NT/.test(userAgent)) {
                        const version = userAgent.match(/Windows NT (\d+\.\d+)/);
                        return version ? `Windows (Version ${version[1]})` : "Windows (Unknown Version)";
                    } 
                    if (/Mac OS X/.test(userAgent)) {
                        const version = userAgent.match(/Mac OS X (\d+[_\.]\d+)/);
                        return version ? `Mac OS X (Version ${version[1].replace('_', '.')})` : "Mac OS X (Unknown Version)";
                    } 
                    if (/Android/.test(userAgent)) {
                        const version = userAgent.match(/Android (\d+\.\d+)/);
                        return version ? `Android (Version ${version[1]})` : "Android (Unknown Version)";
                    } 
                    if (/Linux/.test(userAgent)) {
                        return "Linux (Version detection not specific)";
                    } 
                    if (/iPhone|iPad|iPod/.test(userAgent)) {
                        const version = userAgent.match(/OS (\d+[_\.]\d+)/);
                        return version ? `iOS (Version ${version[1].replace('_', '.')})` : "iOS (Unknown Version)";
                    }
                    return "Unknown Operating System";
                    // detectOS() END
                }
                console.log(detectOS());

            function showCustomAlert(message) {
                const backdrop = document.getElementById('custom-alert-backdrop');
                const dialogMessage = document.getElementById('custom-alert-message');
                dialogMessage.textContent = message;
                backdrop.style.display = 'block';
            }
            // Function to close the custom alert
            function closeCustomAlert() {
                const backdrop = document.getElementById('custom-alert-backdrop');
                backdrop.style.display = 'none';
            }

            // window.onload = () => {} START ~~~~~~~~~~~~~~~~~~
                window.onload = () => {

                    if(consoleLog){console.log('window.onload = ()');}

                    const webcamVideo = document.getElementById("webcamVideo");
                    const cameraFacingMode = "environment"; // rear camera:- "environment"; front camera:- "user"
                    const videoCanvas = document.getElementById("videoCanvas");
                    const canvasImage = document.getElementById('canvasImage');
                    const videoCanvasContext = videoCanvas.getContext('2d', { willReadFrequently: true });

                    const deviceDetails = detectDeviceType();
                    const deviceOS = detectOS();
                    document.getElementById("deviceDetails").innerHTML = deviceDetails + ", " + deviceOS;

                    const motionDetectionThreshold = 100000; // Significant pixel change threshold
                    const motionDetectionInterval = 1000; // ? seconds
                    let motionDetectedTrueCounter = 0;
                    let motionDetectedFalseCounter = 0;
                    let previousFrame = null;
                    let countMotionsDetected = 0; // DOM displays cumulative count
                    let motionDetectionIntervalId = null;

                    // 1 startWebcam() START
                        function startWebcam(){
                            if(consoleLog){console.log('startWebcam() executed.');}
                            document.getElementById("cameraFacingModeToggle").style.visibility="visible";
                            // Customized video settings START
                                const videoConstraints = {
                                        facingMode: cameraFacingMode, // Example: rear camera
                                        width: { ideal: 1280 },    // Ideal resolution width, will automatically scale back if necessary
                                        height: { ideal: 720 },    // Ideal resolution height, will automatically scale back if necessary
                                        frameRate: { ideal: 30 }   // Smooth video at 30fps, will automatically scale back if necessary
                                    };
                            // Customized video settings END
                            async function startWebcamVideo() {
                                try {
                                    // const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
                                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                                    if(consoleLog){console.log('cameraFacingMode requested:- ',cameraFacingMode);}
                                    webcamVideo.srcObject = stream;
                                    window.stream = stream; // Save the stream globally to stop it later
                                    const videoTrack = stream.getVideoTracks()[0];
                                    // Retrieve settings from videoTrack
                                        const settings = videoTrack.getSettings();
                                        let myHTML = "";
                                        // Safely handle undefined settings
                                            function displaySettings(settings) {
                                                const keys = Object.keys(settings);
                                                keys.forEach(key => {
                                                    if(key==="deviceId"){
                                                        return;
                                                    }
                                                    if(key==="groupId"){
                                                        return;
                                                    }
                                                    const value = settings[key];
                                                    if (value === undefined) {
                                                        // console.log(`${key}: Undefined |`);
                                                        myHTML += `${key}: Undefined |`;
                                                    } else {
                                                        if(key==="aspectRatio"){
                                                            // console.log(`${key}: ${value.toPrecision(3)} |`);
                                                            myHTML += `${key}: ${value.toPrecision(3)} |`;
                                                        }else{
                                                            // console.log(`${key}: ${value} |`);
                                                            myHTML += `${key}: ${value} |`;
                                                        }
                                                    }
                                                });
                                            }
                                            // Call the function
                                            displaySettings(settings);                                    
                                            if(consoleLog){console.log(myHTML);}
                                            document.getElementById("cameraDetails").innerHTML = myHTML;
                                        // Safely handle undefined settings
                                    // if(consoleLog){console.log(webcamVideo);}
                                    // currentFacingMode = cameraFacingMode; // Update current mode
                                    // Wait for video metadata before initializing canvas START
                                        webcamVideo.addEventListener('loadedmetadata', () => {
                                            // Capture an initial still image on page load START
                                                captureStillFrame(webcamVideo, videoCanvas, videoCanvasContext, canvasImage);
                                            // Capture an initial still image on page load END
                                            // begin motion detection START
                                                if(motionDetectionIntervalId===null){
                                                    motionDetectionIntervalId = setInterval(() => {
                                                        processVideo(); /// Start motion detection after video loads
                                                        // if(consoleLog){console.log('motionDetectionIntervalId:- ',motionDetectionIntervalId);}
                                                    }, motionDetectionInterval);
                                                    if(consoleLog){console.log('motionDetectionIntervalId started:- ',motionDetectionIntervalId);}
                                                }else{
                                                    if(consoleLog){console.log('motionDetectionIntervalId is already running.');}
                                                }
                                            // begin motion detection END
                                        });
                                    // Wait for video metadata before initializing canvas END
                                } catch (error) {
                                    if(consoleLog){console.error('Error accessing webcam:', error);}
                                    document.getElementById('secCamDashboard').innerHTML = `<p>Error: Unable to access webcam. Please check permissions.</p><p>${error}</p>`;
                                }
                            }
                            startWebcamVideo();
                            // 1 startWebcam() END
                        }
                        // startWebcam();

                    // 2 Motion detection logic START
                        async function processVideo() {
                            if(consoleLog){console.log(`processVideo()`);}
                            // Draw the last motion frame on the canvas START
                                function displayMotionFrame() {
                                    if (lastMotionFrame) {
                                        // Clear the canvas before displaying the motion frame
                                            videoCanvasContext.clearRect(0, 0, videoCanvas.width, videoCanvas.height);

                                        // Draw the motion frame on the canvas
                                            videoCanvasContext.putImageData(lastMotionFrame, 0, 0);
                                    }
                                }
                            // Draw the last motion frame on the canvas END

                            // Convert the canvas content to a data URL and set it as the src of an image
                                canvasImage.src = await videoCanvas.toDataURL('image/png');

                            // Compares two frames for motion START
                                function detectMotion(prevFrame, currFrame) {
                                    // const threshold = 300000; // Sensitivity
                                    const diff = currFrame.data.reduce((count, currentValue, index) => {
                                        return count + (Math.abs(currentValue - prevFrame.data[index]) > 30 ? 1 : 0);
                                    }, 0);
                                    // Motion is detected if pixel difference exceeds a threshold START
                                        // return diff > canvas.width * canvas.height * 0.02; // 2% difference
                                        return diff > motionDetectionThreshold;
                                    // Motion is detected if pixel difference exceeds a threshold END
                                }
                            // Compares two frames for motion END

                            videoCanvas.width = webcamVideo.videoWidth;
                            videoCanvas.height = webcamVideo.videoHeight;
                            videoCanvasContext.drawImage(webcamVideo, 0, 0, videoCanvas.width, videoCanvas.height);
                            const currentFrame = videoCanvasContext.getImageData(0, 0, videoCanvas.width, videoCanvas.height);

                            if (previousFrame) {

                                // determine if motion has occured
                                    const motionDetected = detectMotion(previousFrame, currentFrame);
                                if (motionDetected) {
                                    countMotionsDetected += 1;
                                    motionDetectedTrueCounter += 1;
                                    document.getElementById("countMotionsDetected").innerHTML = countMotionsDetected;
                                    lastMotionFrame = currentFrame; // Save the current frame as the last motion frame
                                    // Draw the last motion frame on the canvas
                                        displayMotionFrame();
        
                                    let moment = _DateTime();
                                    let timeStamp = `${moment.yyyymmdd} ${moment.hhmmss24} ${moment.ampm}`;
                                    if(consoleLog){console.log(`Motion detected:- ${timeStamp}`);}
                                    if(consoleLog){console.log("motionDetectionThreshold:- ",motionDetectionThreshold);}

                                    // Capture a still image at every motion detection
                                        captureStillFrame(webcamVideo, videoCanvas, videoCanvasContext, canvasImage);

                                }else{
                                    motionDetectedFalseCounter += 1;
                                }

                            }
                            previousFrame = currentFrame;

                            document.getElementById("motionDetectedCount").innerHTML = `True: ${motionDetectedTrueCounter}, False: ${motionDetectedFalseCounter}`;
                            if(motionDetectedTrueCounter > 10){
                                motionDetectedTrueCounter = 0; // re-set counter
                                clearInterval(motionDetectionIntervalId);
                                motionDetectionIntervalId = null;
                                // re-start motion detection after X seconds (3000 milliseconds)
                                    setTimeout(() => {
                                        // re-start motion detection START
                                            motionDetectionIntervalId = setInterval(() => {
                                                processVideo();
                                            }, motionDetectionInterval);
                                        // re-start motion detection END
                                    }, 5000);
                            }
                            if(motionDetectedFalseCounter > 10){
                                motionDetectedTrueCounter = 0; // re-set True counter
                                motionDetectedFalseCounter = 0; // re-set False counter
                            }

                            // 3 Motion detection logic END
                        }

                    // capture still frame and put to canvasImage START
                        function captureStillFrame(webcamVideo, videoCanvas, videoCanvasContext, canvasImage) {

                            if(consoleLog){console.log(`captureStillFrame()`);}

                            // ensure canvasImage element is visible
                                canvasImage.style.visibility="visible";

                            // Set canvas size to match the video dimensions
                                videoCanvas.width = webcamVideo.videoWidth;
                                videoCanvas.height = webcamVideo.videoHeight;

                            // Draw the current video frame onto the canvas
                                videoCanvasContext.drawImage(webcamVideo, 0, 0, videoCanvas.width, videoCanvas.height);

                            let moment = _DateTime();
                            let timeStamp = `${moment.yyyymmdd} ${moment.hhmmss24} ${moment.ampm}`;

                            // Convert the canvas content to a data URL and set it as the src of an image
                                canvasImage.src = videoCanvas.toDataURL('image/png');

                            sendImageToServer();
                            // capture still frame and put to canvasImage END
                        }

                    // send still image to server START ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        function sendImageToServer(){
                            if(consoleLog){console.log(`sendImageToServer()`);}
                            // Convert Data URL to Blob START
                                function dataURLToBlob(dataURL) {
                                    const [header, base64Data] = dataURL.split(",");
                                    const mimeType = header.match(/:(.*?);/)[1];
                                    const binaryData = atob(base64Data);
                                    const arrayBuffer = new Uint8Array(binaryData.length);

                                    for (let i = 0; i < binaryData.length; i++) {
                                        arrayBuffer[i] = binaryData.charCodeAt(i);
                                    }

                                    return new Blob([arrayBuffer], { type: mimeType });
                                }
                            // Convert Data URL to Blob END

                                // get dataURL from canvasImage.src
                                    const imgElement = document.getElementById("canvasImage");
                                    const dataURL = imgElement.src; // Get the dataURL
                                    // console.log(dataURL); // You can send this directly to your server
                                // // get dataURL from videoCanvas
                                //     const dataURL = videoCanvas.toDataURL('image/png');
                                // Compress and output the image
                                    const quality = 1 // between 0 and 1
                                    compressedDataURL = videoCanvas.toDataURL("image/jpeg", quality);
                                    // if(consoleLog){console.log('compressedDataURL\n',compressedDataURL);}
                                // Optionally, convert DataURL back to a file
                                    const blob = dataURLToBlob(compressedDataURL);
                                    // if(consoleLog){console.log('compressedDataURL -> blob\n',blob);}

                            // Send the file to the server START
                                async function sendImage(dataURL) {
                                    // sending data START
                                        let moment = _DateTime();
                                        let timeStamp = `${moment.yyyymmdd} ${moment.hhmmss24.replace(":","").replace(":","")} ${moment.ampm}`;
                                        emailAddress = "";
                                        const v_data = JSON.stringify(
                                            {
                                                stillImage: dataURL,
                                                timeStamp: timeStamp,
                                                emailAddress: emailAddress
                                            }
                                        );
                                        const v_options = {method: 'POST', headers: {'Content-Type': 'application/json'},body: v_data};
                                        if(consoleLog){console.log('/update options:- ',v_options)};
                                        // await fetch("http://localhost:2070/sec_cam_still_upload",v_options)
                                        await fetch("https://netit.com.au/sec_cam_still_upload",v_options)
                                        .then(res => {
                                            if(consoleLog){console.log('update:- res:- ',res.body)};
                                            // return res.json();
                                            return res.text();
                                        })
                                        .then((res_data) => {
                                            document.getElementById("stillFrameHistory").innerHTML += `${timeStamp}<br>`;
                                            // if(consoleLog){console.log('update:- ...:- ',res_data)};
                                            if(res_data===dataURL){
                                                console.log("Image received by server, ok");
                                            }else{
                                                console.log("Error: image received by server does not match image sent to server.");
                                            }
                                        })
                                    // sending data END
                                }
                            // Send the file to the server END
                            sendImage(dataURL);

                            // display most recent image sent to server START
                                const previewImg = document.getElementById("previewImage");
                                function updateImage(dataURL) {
                                    previewImg.src = dataURL; // Preview what will be sent to the server
                                    if(consoleLog){console.log("Preview Image Updated");}
                                    let moment = _DateTime();
                                    let timeStamp = `${moment.yyyymmdd} ${moment.hhmmss24} ${moment.ampm}`;
                                    document.getElementById("previewImageTitle").innerHTML = `Most recent image captured:-<br>${timeStamp}`
                                }
                                updateImage(dataURL);
                            // display most recent image sent to server END

                            // send still image to server END ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        }

                    // addMyEventListeners() START
                        function addMyEventListeners() {
                            if(consoleLog){console.log('addMyEventListeners() executed');}

                            // start / stop buttons START
                                const startButton = document.getElementById("startButton");
                                const stopButton = document.getElementById("stopButton");

                                startButton.addEventListener("click", () => {
                                    if(consoleLog){console.log('startButton click');}
                                    startWebcam();
                                    // alert("Camera started.");
                                    showCustomAlert("Camera started.");
                                });

                                stopButton.addEventListener("click", () => {
                                    if(consoleLog){console.log('stopButton click');}
                                    if(typeof motionDetectionIntervalId !== "undefined"){
                                        if(consoleLog){console.log('motionDetectionIntervalId stopped:-',motionDetectionIntervalId);}
                                        clearInterval(motionDetectionIntervalId);
                                        motionDetectionIntervalId = null;
                                        document.getElementById("cameraFacingModeToggle").style.visibility="hidden";
                                        showCustomAlert("Camera stopped.");
                                    }else{
                                        if(consoleLog){console.log('UNDEFINED > motionDetectionIntervalId:-');}
                                        showCustomAlert("Camera NOT stopped.");
                                    }
                                    // window.stream.getTracks().forEach((track) => track.stop());
                                    // webcamVideo.srcObject = null;
                                    // videoCanvasContext.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                                    // alert("Camera stopped.");
                                });
                            // start / stop buttons END

                            // toggle camera facing mode
                                document.getElementById("cameraFacingModeToggle").addEventListener("click", toggleCamera);

                        // addMyEventListeners() END
                        }
                        addMyEventListeners();

                        // toggle camera facing mode START
                            let currentFacingMode = "user"; // Start with the front-facing camera
                                function toggleCamera() {
                                    // Stop any active video streams
                                        if (window.stream) {
                                            window.stream.getTracks().forEach((track) => track.stop());
                                        }
                                    // Toggle the facingMode
                                        currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
                                    // Define constraints with the updated facingMode
                                        const constraints = {
                                        video: {
                                            facingMode: currentFacingMode,
                                            },
                                        };
                                    // Request the video stream
                                        navigator.mediaDevices.getUserMedia(constraints)
                                        .then((stream) => {
                                            window.stream = stream; // Save the stream globally to stop it later
                                            const videoElement = document.getElementById("webcamVideo");
                                            videoElement.srcObject = stream;
                                            showCustomAlert("Camera facing mode toggled.");
                                        })
                                        .catch((error) => {
                                            console.error("Error accessing camera:", error);
                                        });
                                // toggle camera facing mode END
                                }

                    // window.onload = () => {} END ~~~~~~~~~~~~~~~~~~
                }

        </script>

    </head>
    <body>

        <div class="media-container">

            <div id="wrapperStartStopButtons" class="wrapperStartStopButtons">
                <div id="startButton" class="startButton">START</div>
                <div id="stopButton" class="stopButton">STOP</div>
            </div>

            <div id="wrapperCameraFacingModeToggle" class="wrapperCameraFacingModeToggle">
                <div id="cameraFacingModeToggle" class="cameraFacingModeToggle">Toggle Camera</div>
            </div>    

            <video id="webcamVideo" class="media-element webcam-video" autoplay playsinline>
                The "video" element is not supported by this browser.
            </video>
    
            <canvas id="videoCanvas" class="media-element video-canvas">
                The "canvas" element is not supported by this browser.
            </canvas>

            <img id="canvasImage" class="media-element canvas-image" src="initial-image.jpg" alt=""/>
        
        </div>

        <div id="secCamDashboard" class="sec-cam-dashboard">
            <p>Security Camera</p>
            <p id="countMotionsDetected">0</p>
            <p id="motionDetectedCount">0</p>
            <p id="cameraDetails"></p>
            <p id="deviceDetails"></p>
        </div>

        <div id="previewImageContainer" class="previewImageContainer">
            <div id="previewImageTitle">Most recent image captured.</div>
            <img id="previewImage" class="previewImage" alt="Preview Image" />
        </div>

        <div id="stillFrameHistoryContainer" class="stillFrameHistoryContainer">
            <div id="stillFrameHistory"></div>
        </div>

        <div id="custom-alert-backdrop">
            <div id="custom-alert-dialog">
                <p id="custom-alert-message"></p>
                <button onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
        
    </body>
</html>